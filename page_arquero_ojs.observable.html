<!doctype html>
<notebook theme="air">
  <title>Exemple avec chargement de la data</title>
  <script id="0" type="text/markdown">
    # Exemple avec chargement de la data
  </script>
  <script id="1" type="application/vnd.observable.javascript" pinned="">
    import { aq, op } from '@uwdata/arquero' // le dplyr ou pandas du javascript
  </script>
  <script id="2" type="application/vnd.observable.javascript">
    // la donnée sera un dataframe au format arquero, ce format est compatible directement avec la librairie plot intégré de ojs (sinon il est nécessaire de retransformer la donnée en object javascript pour les autres librairies)
myData = aq.loadCSV("./data/donnees_combined.csv");
  </script>
  <script id="3" type="application/vnd.observable.javascript">
    Inputs.table(myData)
  </script>
  <script id="4" type="application/vnd.observable.javascript">
    myDataTrancheAge = myData
  .filter(d => op.includes(d.indicateur, '_ans'))
  </script>
  <script id="5" type="application/vnd.observable.javascript">
    // Afficher la donnée
Inputs.table(myDataTrancheAge)
  </script>
  <script id="6" type="application/vnd.observable.javascript">
    viewof myQuartier = Inputs.range([1, 342], {step: 1, label: "Choisir un quartier"})
  </script>
  <script id="7" type="application/vnd.observable.javascript">
    // Pourquoi aq.escape ? pour pouvoir mettre une variable extérieur au dataframe, aq.escape permet d'écrire du javascript vanilla à l'intérieur des verbes d'arquero
myDataQuartier = myDataTrancheAge
  .filter(aq.escape(d => d.id== myQuartier && d.echelle == 'recoquartier'))
  </script>
  <script id="8" type="application/vnd.observable.javascript">
    // Afficher les données
Inputs.table(myDataQuartier)
  </script>
  <script id="9" type="application/vnd.observable.javascript">
    Plot.plot({
  title: "Ceci est un test",
  subtitle:"sous titre",
  marginLeft: 45,
  color: {legend: true, scheme:"reds" },
  marks: [
    Plot.barX(
      myDataQuartier,
        { x: "valeur" , y : "id", fill: "indicateur"}
    )
  ]
})
  </script>
  <script id="10" type="application/vnd.observable.javascript">
    // la librairie arquero permet de chaîner les traitements comme en R ou Python
dataSelectQ = myData
                .select('id','indicateur','valeur')
                .filter(aq.escape(d => d.indicateur == 'commune' || d.indicateur == 'nom_iris'))
                .groupby('id')
                .pivot('indicateur', 'valeur')
  </script>
  <script id="11" type="application/vnd.observable.javascript">
    // Afficher la donnée
Inputs.table(dataSelectQ)
  </script>
  <script id="12" type="application/vnd.observable.javascript">
    // Le menu déroulant
viewof Q = Inputs.select(dataSelectQ, {label: "Choisir un quartier", format: d => `n° ${d.id}-${d.commune} (${d.nom_iris})` })
  </script>
  <script id="13" type="application/vnd.observable.javascript">
    // Préparation de la donnée avec arquero :
myDataGrapheStackBar = myData
                  .filter( aq.escape(d => (d.id== Q.id && d.echelle == 'recoquartier') || d.echelle == 'multi_recoquartiers_region'  ) )
                  .filter( d => op.includes(d.indicateur, '_ans') )
                  .select('echelle','indicateur','valeur')
  </script>
  <script id="14" type="application/vnd.observable.javascript">
    // Un tableau sur 2 colonnes en faisant un pivot à la volée
Inputs.table(
  myDataGrapheStackBar.groupby('indicateur').pivot('echelle','valeur'), {
  header: {
    multi_recoquartiers_region: "Ensemble des RecoQ",
    recoquartier: `RecoQ n° ${Q.id}`
  },
  align: {
    multi_recoquartiers_region: "center",
    recoquartier: "center"
  }
})
  </script>
  <script id="15" type="application/vnd.observable.javascript">
    // Des stack bar série               
Plot.plot({
  marginLeft: 45,
  marginBottom: 60,
  marginTop: 60,
  style: {fontSize: "25px"},
  color: {legend: true },
  marks: [
    Plot.barY(
      myDataGrapheStackBar,
        { x : "echelle" ,y: "valeur" , fill: "indicateur", offset: "normalize", tip: true}
    )
  ]
})
  </script>
  <script id="16" type="application/vnd.observable.javascript">
    // Un exemple de la vraie vie, pour faire ce graphe, les valeurs n'ont pas été comprises comme des nombres mais comme du texte, en javascript on utilise parseFloat pour convertir ce texte en nombre et cela s'intègre bien dans un traitement arquero

myDataBoxPlot = myData
                  .filter( d => d.echelle == 'recoquartier')
                  .filter( d => op.includes(d.indicateur, '_ans') )
                  .derive({
                    valeurNumber: aq.escape(d => parseFloat(d.valeur))
                  })
                  .select('id','echelle','indicateur','valeurNumber')
  </script>
  <script id="17" type="application/vnd.observable.javascript">
    myDataBoxPlotQ = myDataBoxPlot.filter(aq.escape(d => d.id == Q.id))

//Inputs.table(myDataBoxPlotQ)
  </script>
  <script id="18" type="application/vnd.observable.javascript">
    Plot.plot({
  caption: "Les boîtes à moustache représentent la dispersion des valeurs de l'ensemble des quartiers par tranche d'âge, les symboles représentent les valeurs du quartier sélectionné",
  y: {
    grid: true
  },
  color: {legend:true, style: {fontSize: "14px"}},
  symbol: {legend: true, style: {fontSize: "14px"}},
  style: {fontSize: "14px"},
  marginBottom: 40,
  marginTop: 20,
  marks: [
    // boîte à moustache en série pour réprésenter l'ensemble des quartiers
    Plot.boxY(myDataBoxPlot, {x: "indicateur", y: "valeurNumber", fill:"indicateur"}),

    // et un symbole pour positionner le quartier sélectionné
    Plot.dot(myDataBoxPlotQ, {
      x: "indicateur", 
      y: "valeurNumber", 
      fill: "white", 
      stroke:"black", 
      r: 5, 
      symbol: "indicateur",
      // un canal permet de rajouter des informations sur mesure à partir des données
      channels: {
        quartier: {
          value: "id",
          label: "Quartier n°"
        },
      },
      tip: {
        format: {
          quartier: true,
          id:true,
          indicateur: true,
          y: (d) => `${d*100} %`,
          stroke: false
        }
      }
    })
  ]
})
  </script>
</notebook>